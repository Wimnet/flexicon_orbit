This is the GNU Radio package containing out-of-tree (OOT) modules to enable full-duplex (FD) wireless with our integrated FD radios. In this README we will describe each available OOT module and how it is used. 

To use the fullduplex blocks, the Python namespaces is in 'fullduplex', which is imported as:

    import fullduplex

See the Doxygen documentation for details about the blocks available in this package. A quick listing of the details can be found in Python after importing by using:

    help(fullduplex)
    
While the code is customized for our setup, we encourage other experimenters to modify it as necessary for their experiments. If you use this code, we would greatly appreciate citations to  the following papers:

*Manav Kohli, Tingjun Chen, Mahmood Baraani Dastjerdi, Jackson Welles, Ivan Seskar, Harish Krishnaswamy, and Gil Zussman, "Open-Access Full-Duplex Wireless in the ORBIT and COSMOS Testbeds," in Proc. ACM MobiCom'20 Workshop on Wireless Network Testbeds, Experimental evaluation & CHaracterization (WiNTECH '20) (invited paper), Sept. 2020.* [[download](https://wimnet.ee.columbia.edu/wp-content/uploads/2020/08/wintech2020_orbit_cosmos_fullduplex_integration.pdf)]

*Tingjun Chen, Mahmood Baraani Dastjerdi, Jin Zhou, Harish Krishnaswamy, and Gil Zussman, “Wideband Full-Duplex Wireless via Frequency-Domain Equalization: Design and Experimentation,” in Proc. ACM MobiCom'19, Oct. 2019.* [[download](https://wimnet.ee.columbia.edu/wp-content/uploads/2018/12/FDE_MobiCom19.pdf)]

## OOT Modules fpr Full Duplex
### FD Packet Encap2 
This block packetizes OFDM symbols generated by the OFDM Transmitter block from the gr-digital library. The input is a complex stream, and the output is a complex stream, with each OFDM packet separated by a specified number of zero samples before and after. The following parameters are used:

* **Debug**: If set to `Enable`, outputs debug information to the GNU Radio console.
* **Delay**: Always set to `Disable`.
* **Delay Sec**: Unused, can be set to any value
* **Pad Front**: defines the length of the zero padding before the OFDM packet starts. The greater this value, the lower the effective packet rate.
* **Pad Tail**: defines the length of the zero padding after the OFDM packet ends.
* **Pad Pos**: defines the position of additional OFDM symbols used for self-interference (SI) channel estimation in the Digital SIC block. Accepts value 0 or 1. 
* **Premultiplier**: Used for digital gain. Normally set to `1`.
* **Sync Word**: This determines which OFDM symbols to use for the SI channel estimation. `0` adds zero padding instead of a symbol, `1` adds sync word 1 used by the OFDM transmitter, `2` adds sync word 2 used by the OFDM transmitter, `3` utilizes the long training sequence (LTS) as used by 802.11.

The padding can be modified, but it is very important that the values used are consistent throughout the flowgraph. The same is true for the Pad Pos parameter.

### Digital SIC
This block accepts two complex valued inputs representing packetized data with a particular format and is designed to be used with the FD Packet Encap2 block. The top input is the transmitted data, and the bottom input is the received data.

The parameters available in this block are described below:
* **Debug**: If set to `True`, outputs debug information to the GNU Radio console.
* **Delay Tx2Rx**: defines the delay of the Rx samples with respect to the Tx samples. The optimal value is dependent on the bandwidth. With a bandwidth of 10 MHz, `40` should be used.
* **Pad Front**: defines the length of the zero padding before the OFDM packet starts. Must match the value defined in FD Packet Encap2.
* **Sig Pilot Pos**: defines the position of the extra OFDM pilot sybols used for channel estimation. Must match the value "Pad Pos" defined in FD Packet Encap2.
* **Frame Length**: defines how long the OFDM packet is, in samples.
* **SI channel k**: The single-sided width of the finite impulse response (FIR) filter used for digital SIC. `k = 10` is generally sufficient, which leads to `10*2 + 1 = 21` taps.
* **SI channel dim**: The dimension of the FIR. Generally, a single-dimension filter is sufficient, and `1` can be used.
* **Premultiplier**: Used for digital gain. Is normally set to `1`.

The three outputs are as follows:
* **Top**: The OFDM packets without digital SIC.
* **Middle**: The OFDM packets after digital SIC.
* **Bottom**: The digital SIC filter taps. 

The Digital SIC block will remove the paddings added by the FD Packet Encap2 block.

### FDE Config
This block is used to control the Gen-2 canceller PCB using the [SUB-20](http://www.xdimax.com/sub20/sub20.html) API. It accepts a total of 15 parameters, one for the SUB-20's serial number and 14 parameters representing the 14 configurable components on the Gen-2 canceller PCB and antenna tuner combined. These are described below:
* **FDE Board**: For the radio addressed by `192.168.30.3`, use `552D`. For the radio addressed by `192.168.30.4`, use `5647`.
* **Canceller Path** - Determines whether the wideband FDE or narrowband Gen-1 canceller path is used. 0 = FDE, 1 = Gen-1.
* **Attenuator** - The attenuator values for FDE tap 0 and tap 1. Attenuator 2 is for the Gen-1 path. Higher values lead to greater attenuation. Values are between 0 and 127.
* **DAC** - The phase shifter values for FDE tap 0 and tap 1. DAC 2 is for the Gen-1 path. Values are between 0 and 255.
* **CF** - The center frequency for FDE tap 0 and tap 1. Higher values lead to lower center frequency. Values are between 0 and 15.
* **QF** - The quality factor for FDE tap 0 and tap 1. Higher values lead to lower quality factor. Values are between 0 and 31, but values over 8 tend to degrade performance.
* **Init Cap Val/Addr** - Unused
* **Tuner Cap*** - these control the antenna tuner capactitors. Values are between 0 and 15.

It is important to note that this block will only update the canceller PCB when a value is changed through the GNU Radio GUI. It will **not** initialize the board when the flowgraph is run. This is to aid the use of a GUI for configuring the canceller PCB - a configuration may be held for an indefinite amount of time as long as the GUI controls are not modified. If the GUI control elements must be removed and values are directly set inside the FDE Config block, we recommend to keep the canceller path selection GUI control so this can be used to force an update on the PCB if necessary.

### Gen-1 Config
This block performs the same purpose as the FDE Config block, but as it is for the Gen-1 PCB canceller, it only has two controllable components, and the serial number is omitted as there is only one SUB-20 device connected to the PC. The two configurable components are:
* **Attenuator** - Higher values lead to greater attenuation. Values are between 0 and 127.
* **DAC** - Controls the phase shifter. Values are between 0 and 255.

## Other OOT Modules
We also have OOT modules developed for other functionality relating to, but not directly involved in our FD methods. 

### SNR Calculator
This measures the SNR of each individual OFDM packet. It accepts the following parameters:
* **Debug**: If set to `True`, outputs debug information to the GNU Radio console.
* **Delay Tx2Rx**: defines the delay of the Rx samples with respect to the Tx samples. The optimal value is dependent on the bandwidth. With a bandwidth of 10 MHz, `40` should be used.
* **Pad Front**: defines the length of the zero padding before the OFDM packet starts. The value here must be determined by the experimenter and is dependent on the data entering the block. For example, if the paddings from FD Packet Encap2 have been removed, then this will *not* be the same value as used in the FD Packet Encap2 block.
* **Data Symbols**: how many symbols make up the entire OFDM packet. This includes sync words 1&2, the SIG field, and all data symbols. This will need to be computed by the experimenter - in the example experiments the value used is `6`.
* **Noise Start Index** - The value here depends on the paddings used for each packet. It is usually set to zero, but might need to be determined by the experimenter  through investigating the complex valued data entering this block.
* **Noise Length** - How many noise samples to use for computing the noise power. This can be determined by the experimenter as well. Care must be taken to not use too large of a number so that packet samples are not included in the noise.

### OFDM Constellation
This performs a basic phase correction on the input OFDM packets and outputs constellation points. The output of this block must be fed into a QT GUI Constellation  Sink. It also outputs the measured EVM of each packet. The following parameters are accepted:
* **Debug**: If set to `True`, outputs debug information to the GNU Radio console.
* **Delay Tx2Rx**: defines the delay of the Rx samples with respect to the Tx samples. This value may not be the same as used in the Digital SIC block.
* **Pad Front**: defines the length of the zero padding before the OFDM packet starts. The value here must be determined by the experimenter and is dependent on the data entering the block. For example, if the paddings from FD Packet Encap2 have been removed, then this will *not* be the same value as used in the FD Packet Encap2 block.
* **Frame Length**: defines how long the OFDM packet is, in samples. This is the same as used in the Digital SIC block.

### Miscellaneous 
There are two other modules used in our example flowgraphs. The first, Packet Count, is used to count how many packets pass through it. It outputs the current count in two ways - as a floating point and also as a message. Outputting as a message allows multiple packet count blocks to be used asnychronously.

The second is the Async Divide - this takes two message format inputs (generally floating point numbers) and performs a division. The output only updates when either of the two inputs update, and enforces no timing requirement on the inputs. Therefore, this can be used to perform division of numbers which are asynchronous.
